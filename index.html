<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>LuLu Dev Build</title>
</head>
<body>
  <div class="chat-container">
    
    <!-- Settings Button (Cogwheel) -->
    <button id="settingsButton" class="settings-btn">⚙️</button>

    <!-- Sidebar / Settings Panel (Initially Hidden) -->
    <div class="sidebar hidden" id="settingsPanel">
      <h2>Settings</h2>
      <label for="username">Username:</label>
      <input type="text" id="username">
      <button id="saveSettings">Save</button>
      <label for="themeToggle">Dark Mode:</label>
      <input type="checkbox" id="themeToggle">
    </div>

    <!-- Chat Section -->
    <div class="chat-box">
      <div class="messages-container" id="messages"></div>
      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
        <input type="file" id="mediaInput" accept="image/*,video/*">
        <button id="sendButton">Send</button>
      </div>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const mediaInput = document.getElementById('mediaInput');
    const usernameInput = document.getElementById('username');
    const saveSettingsButton = document.getElementById('saveSettings');
    const themeToggle = document.getElementById('themeToggle');
    const settingsButton = document.getElementById('settingsButton');
    const settingsPanel = document.getElementById('settingsPanel');
    const ws = new WebSocket('ws://localhost:3000');

    // Load settings
    let username = localStorage.getItem('username') || prompt("Enter your name:");
    if (!username) username = "Anonymous";
    localStorage.setItem('username', username);
    usernameInput.value = username;
    
    const darkMode = localStorage.getItem('darkMode') === "true";
    document.body.classList.toggle('dark', darkMode);
    themeToggle.checked = darkMode;

    // Toggle settings menu visibility
    settingsButton.addEventListener('click', () => {
      settingsPanel.classList.toggle('visible');
    });

    // Save settings
    saveSettingsButton.addEventListener('click', () => {
      localStorage.setItem('username', usernameInput.value);
      localStorage.setItem('darkMode', themeToggle.checked);
      location.reload();
    });

    ws.addEventListener('message', (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'history') {
        data.messages.forEach(msg => displayMessage(msg.text, msg.sender, msg.media));
      } else if (data.type === 'message') {
        displayMessage(data.text, data.sender, data.media);
      }
    });

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      const mediaFile = mediaInput.files[0];

      // Prevent empty messages
      if (!text && !mediaFile) {
        alert("You can't send an empty message!");
        return;
      }

      let mediaData = null;
      if (mediaFile) {
        const reader = new FileReader();
        reader.readAsDataURL(mediaFile);
        reader.onload = () => {
          mediaData = reader.result;
          sendToServer(text, mediaData);
        };
      } else {
        sendToServer(text, null);
      }

      messageInput.value = '';
      mediaInput.value = '';
    }

    function sendToServer(text, media) {
      const messageData = { sender: username, text, media };
      ws.send(JSON.stringify(messageData));
      displayMessage(text, username, media, true);
    }

    function displayMessage(message, sender, media, isSender = false) {
      const messageContainer = document.createElement('div');
      const messageElement = document.createElement('div');
      const nameElement = document.createElement('span');

      nameElement.textContent = sender + ': ';
      nameElement.style.fontWeight = "bold";
      nameElement.style.marginRight = "5px";

      messageElement.textContent = message;
      messageContainer.classList.add('message-container');

      if (isSender) {
        messageContainer.classList.add('sender-message-container');
        messageElement.classList.add('message-bubble', 'sender-message-bubble');
      } else {
        messageElement.classList.add('message-bubble');
      }

      messageElement.prepend(nameElement);
      messageContainer.appendChild(messageElement);
      
      // Handle media
      if (media) {
        const mediaElement = document.createElement(media.startsWith('data:image') ? 'img' : 'video');
        mediaElement.src = media;
        if (mediaElement.tagName === 'VIDEO') mediaElement.controls = true;
        mediaElement.classList.add('media');
        messageContainer.appendChild(mediaElement);
      }

      messagesDiv.appendChild(messageContainer);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;  // Auto-scroll to the latest message
    }
  </script>
</body>
</html>
